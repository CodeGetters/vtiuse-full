# å·¥ä½œæµåç§°ï¼šè‡ªåŠ¨ä¾èµ–æ›´æ–°
name: Auto Dependency Update

# è§¦å‘æ¡ä»¶
on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œï¼ˆUTC æ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´ 10 ç‚¹ï¼‰
    - cron: "0 2 * * *"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨åœ¨ GitHub Actions ç•Œé¢è§¦å‘

# å®šä¹‰å·¥ä½œæµç¨‹
jobs:
  update-dependencies:
    # æŒ‡å®šè¿è¡Œç¯å¢ƒä¸ºæœ€æ–°ç‰ˆ Ubuntu
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # è·å–å®Œæ•´çš„ git å†å²è®°å½•ï¼Œç”¨äºæ£€æŸ¥æœ€åæäº¤æ—¶é—´

      # æ­¥éª¤ 2ï¼šæ£€æŸ¥æœ€åä¸€æ¬¡æäº¤è·ç°åœ¨çš„æ—¶é—´
      - name: Check last commit time
        id: check-time
        run: |
          # è·å–æœ€åä¸€æ¬¡æäº¤çš„æ—¶é—´æˆ³
          LAST_COMMIT_TIME=$(git log -1 --format=%ct)
          # è·å–å½“å‰æ—¶é—´æˆ³
          CURRENT_TIME=$(date +%s)
          # è®¡ç®—è·ç¦»æœ€åä¸€æ¬¡æäº¤çš„å°æ—¶æ•°
          HOURS_SINCE_LAST_COMMIT=$(( ($CURRENT_TIME - $LAST_COMMIT_TIME) / 3600 ))
          # å¦‚æœè¶…è¿‡ 24*7=168 å°æ—¶ï¼Œåˆ™è®¾ç½®æ›´æ–°æ ‡å¿—ä¸º true
          if [ $HOURS_SINCE_LAST_COMMIT -gt 168 ]; then
            echo "should_update=true" >> $GITHUB_OUTPUT
          else
            echo "should_update=false" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤ 3ï¼šè®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        if: steps.check-time.outputs.should_update == 'true' # ä»…åœ¨éœ€è¦æ›´æ–°æ—¶æ‰§è¡Œ
        uses: actions/setup-node@v3
        with:
          node-version: "20" # ä½¿ç”¨ Node.js 18.x ç‰ˆæœ¬

      # æ­¥éª¤ 4ï¼šæ›´æ–°ä¾èµ–
      - name: Update dependencies
        if: steps.check-time.outputs.should_update == 'true' # ä»…åœ¨éœ€è¦æ›´æ–°æ—¶æ‰§è¡Œ
        run: |
          pnpm update    # æ›´æ–°æ‰€æœ‰ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬
          pnpm install  # å®‰è£…æ›´æ–°åçš„ä¾èµ–

      # æ­¥éª¤ 5ï¼šåˆ›å»ºæ‹‰å–è¯·æ±‚
      - name: Create Pull Request
        if: steps.check-time.outputs.should_update == 'true' # ä»…åœ¨éœ€è¦æ›´æ–°æ—¶æ‰§è¡Œ
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨ GitHub æä¾›çš„ token
          commit-message: "chore(deps): update dependencies" # æäº¤ä¿¡æ¯
          title: "ğŸ¤– Auto Dependency Update" # PR æ ‡é¢˜
          body: | # PR æè¿°
            è‡ªåŠ¨ä¾èµ–æ›´æ–°

            - æ›´æ–°æ‰€æœ‰è¿‡æ—¶çš„ä¾èµ–é¡¹
            - ç”±ä¾èµ–æ›´æ–°æœºå™¨äººè‡ªåŠ¨åˆ›å»º
          branch: auto-dependency-update # åˆ›å»ºæ–°åˆ†æ”¯
          delete-branch: true # åœ¨ PR åˆå¹¶ååˆ é™¤åˆ†æ”¯
